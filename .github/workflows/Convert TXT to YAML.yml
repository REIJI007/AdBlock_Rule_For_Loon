name: Convert TXT to YAML

on:
  schedule:
    - cron: '*/20 * * * *'  # 每20分钟运行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  convert-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: pip install PyYAML

      - name: Convert TXT to YAML
        run: |
          import yaml
          
          def convert_txt_to_yaml(input_file, output_file):
              with open(input_file, 'r') as f:
                  content = f.read().splitlines()
              
              yaml_content = yaml.dump(content, default_flow_style=False)
              
              with open(output_file, 'w') as f:
                  f.write(yaml_content)
          
          convert_txt_to_yaml('adblock_reject_surge_ruleset.txt', 'adblock_reject_surge_ruleset.yaml')
          convert_txt_to_yaml('adblock_reject_surge_domainset.txt', 'adblock_reject_surge_domainset.yaml')
        shell: python

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add adblock_reject_surge_ruleset.yaml adblock_reject_surge_domainset.yaml
          git commit -m "Convert TXT to YAML" || exit 0
          
          # 添加推送错误重试机制
          max_retries=5
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if git push; then
              echo "Successfully pushed changes"
              exit 0
            else
              echo "Push failed. Retrying in 30 seconds..."
              sleep 30
              retry_count=$((retry_count + 1))
            fi
          done
          
          echo "Failed to push changes after $max_retries attempts"
          exit 1
        env:
          TOKEN: ${{ secrets.TOKEN }}
